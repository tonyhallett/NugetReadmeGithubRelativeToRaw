<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
      <UsingTask TaskName="ReadmeRewriterTask"
             AssemblyFile="$(MSBuildThisFileDirectory)..\tasks\netstandard2.0\$(MSBuildThisFileName).dll" />

     <!-- 1. Always define a dummy target to anchor things if BeforePack is not defined -->
    <Target Name="BeforePackHook_NugetReadmeGithubRelativeToRaw" />

    <!-- 2. If BeforePack is not defined, point it to BeforePackHook_NugetReadmeGithubRelativeToRaw -->
    <PropertyGroup>
      <BeforePack Condition="'$(BeforePack)' == ''">BeforePackHook_NugetReadmeGithubRelativeToRaw</BeforePack>
    </PropertyGroup>

    <!-- or instead _GetPackageFiles -->
    <Target Name="ReadmeRewrite_ForPack"
          BeforeTargets="$(BeforePack)"
          Condition="'$(IsPackable)' != 'false'">

    <!-- Require the caller to set PackageReadmeFile (relative to project directory) -->
    <Error Condition="'$(PackageReadmeFile)' == ''"
           Text="ReadmeRewrite: you must set &lt;PackageReadmeFile&gt; in the project (path RELATIVE to the project directory, e.g. README.nuget.md)." />

    <Error Condition="'$(RepositoryUrl)' == ''"
           Text="ReadmeRewrite: you must set &lt;RepositoryUrl&gt; in the project." />

    <PropertyGroup>
      <_OutputReadmeAbsolute>$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(PackageReadmeFile)'))</_OutputReadmeAbsolute>
    </PropertyGroup>

    <!-- Run the rewrite task -->
    <ReadmeRewriterTask
        ProjectDirectoryPath="$(MSBuildProjectDirectory)"
        ReadmeRelativePath="$(BaseReadme)"
        OutputReadme="$(_OutputReadmeAbsolute)"
        RepositoryUrl="$(RepositoryUrl)"
        ReadmeRepositoryUrl="$(ReadmeRepositoryUrl)"
        RepositoryBranch="$(_RepoBranch)"
        RemoveCommentIdentifiers="$(RemoveCommentIdentifiers)"
        RemoveReplaceItems="@(ReadmeRemoveReplace)"
        />

    <ItemGroup>
        <None Include="$(PackageReadmeFile)" Pack="true" PackagePath=""/>
    </ItemGroup>
  </Target>
</Project>
