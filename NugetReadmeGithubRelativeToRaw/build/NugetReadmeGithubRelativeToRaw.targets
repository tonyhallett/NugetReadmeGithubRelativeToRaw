<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
      <UsingTask TaskName="ReadmeRewriterTask"
             AssemblyFile="$(MSBuildThisFileDirectory)..\tasks\netstandard2.0\$(MSBuildThisFileName).dll" />

     <!-- 1. Always define a dummy target to anchor things if BeforePack is not defined -->
    <Target Name="BeforePackHook_NugetReadmeGithubRelativeToRaw" />

    <!-- 2. If BeforePack is not defined, point it to BeforePackHook_NugetReadmeGithubRelativeToRaw -->
    <PropertyGroup>
      <BeforePack Condition="'$(BeforePack)' == ''">BeforePackHook_NugetReadmeGithubRelativeToRaw</BeforePack>
    </PropertyGroup>

    <!-- or instead _GetPackageFiles -->
    <Target Name="ReadmeRewrite_ForPack"
          BeforeTargets="$(BeforePack)"
          DependsOnTargets="_InitializeNuspecRepositoryInformationProperties"
          Condition="'$(IsPackable)' != 'false'">

        <!-- Require the caller to set PackageReadmeFile (relative to project directory) -->
        <Error Condition="'$(PackageReadmeFile)' == ''"
               Text="ReadmeRewrite: you must set &lt;PackageReadmeFile&gt; in the project (path RELATIVE to the project directory, e.g. README.nuget.md)." />

        <PropertyGroup>
          <!-- Extract filename and package subdirectory from PackageReadmeFile -->
	      <_ReadmeFilename>$([System.IO.Path]::GetFileName($(PackageReadmeFile)))</_ReadmeFilename>
          <_ReadmePackageDir>$([System.IO.Path]::GetDirectoryName($(PackageReadmeFile)))</_ReadmePackageDir>

          <!-- Resolve output directory -->
          <_ReadmeOutputDir Condition="'$(ReadmeOutputRelativeDirectory)' != ''">$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(ReadmeOutputRelativeDirectory)'))</_ReadmeOutputDir>
          <_ReadmeOutputDir Condition="'$(ReadmeOutputRelativeDirectory)' == ''">$(MSBuildProjectDirectory)</_ReadmeOutputDir>

          <_OutputReadmeAbsolute>$([System.IO.Path]::Combine('$(_ReadmeOutputDir)', '$(_ReadmeFilename)'))</_OutputReadmeAbsolute>
        </PropertyGroup>

        <!-- Run the rewrite task -->
        <ReadmeRewriterTask
            ProjectDirectoryPath="$(MSBuildProjectDirectory)"
            ReadmeRelativePath="$(BaseReadme)"
            OutputReadme="$(_OutputReadmeAbsolute)"

            RepositoryUrl="$(RepositoryUrl)"
            ReadmeRepositoryUrl="$(ReadmeRepositoryUrl)"
            
            RepositoryBranch="$(RepositoryBranch)"
            RepositoryCommit="$(RepositoryCommit)"
            RepositoryRef="$(RepositoryRef)"
            
            RemoveCommentIdentifiers="$(RemoveCommentIdentifiers)"
            RemoveReplaceItems="@(ReadmeRemoveReplace)"
            />

        <ItemGroup>
            <None Include="$(_OutputReadmeAbsolute)" Pack="true" PackagePath="$(_ReadmePackageDir)"/>
        </ItemGroup>
  </Target>
</Project>
